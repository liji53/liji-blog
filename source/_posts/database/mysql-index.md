---
title: mysql-索引
date: 2021-08-21 13:21:02
tags:
categories: 数据库
---
# mysql-索引
在使用数据库时，表索引的设计，以及使用sql语句时如何使用索引，是DBA、开发非常关心的事情。如果连索引的实现原理都不清楚，根本就无法写出高效的查询语句，也无法对表结构进行优化。

### 聚簇索引
##### 1.索引的结构
我们已经知道了在一个页中如何通过页目录对页内数据进行查找（回顾[mysql-存储布局]()数据页格式）。
而如何快速找到数据在哪个页中，则通过索引实现，索引页和数据页的页类型是相同的，因为InnoDB也是按照数据页的格式存放索引。
如图所示：
![](Images/index_directory.png)
聚簇索引页它存放的是主键值 + 页号。
使用聚簇索引查找数据时，通主键遍历索引页，就可以找到页号了。
如果数据量很大，则需要多个索引页，这些索引页又需要更上一层的索引页。
如图所示：
![](Images/B+Tree.png)
现在我们可以知道，实际的用户记录存放在B+树的最底层叶子节点上。
实际应用中B+树的层数也就3-4层，一般不会超过4层。
从IO次数来看，如果是指定主键查询，4层的B+树，只需要4次磁盘访问即可。

##### 2.聚簇索引
聚簇索引使用主键值的大小进行排序，包括内页数据按照主键值排序成一个单向链表，索引页也按照主键值大小排序形成双向链表
这种B+树就是聚簇索引，前面展示的图即为聚簇索引，聚簇索引包含实际用户数据。
聚簇索引不是认为创建的，默认就有。

##### 3.根节点
在刚创建索引的时候，会为这个索引建立一个根节点，由于刚开始没有数据，数据直接往根节点插入，等到这个根节点满的时候，会把页数据复制到一个新的页，再对这个新页进行页分裂操作，而原来的根节点变成存储索引的非叶子节点。
根节点页面是不动的，这样InnoDB再需要遍历索引的时候，就能知道索引的入口。

### 二级索引
##### 1. 二级索引的结构
聚簇索引只有在查询条件是主键的情况下才能使用，如果我们想要以别的列作为查询条件，如何避免全表查询呢？
我们可以通过建立多颗B+树，来达到这个目的，如下图所示：
![](Images/second_index.png)

##### 2. 与聚簇索引的区别
二级索引与聚簇索引的区别：
1. 二级索引的叶子节点存储的不是*用户数据*，而是 *索引列+主键值*
2. 非叶子节点存储的不是 *主键+页号*，而是 *索引列+页号*
3. 二级索引按照*索引列大小排序*，而聚簇索引按照*主键值排序*

因此通过二级索引查找，能找到对应的主键值，再通过主键值到聚簇索引中查找，就能找到完整的用户记录了(再到聚簇索引中查找的过程称为回表)

##### 3.联合索引
联合索引是同时以多个列作为索引，但联合索引的多个列并不是等价的，它是先按照一个列进行排序，如果值相同，再按照第二个列排序，依此类推。
![](Images/composite_index.png)
联合索引的结构和二级索引基本一样，因此联合索引本质上还是二级索引。

### 索引的使用
##### 1. 索引的代价
显而易见，索引有2方面的代价：
1. 空间上，每建立一个索引，就需要建立一颗B+树
2. 时间上，进行增删改时，需要对索引进行维护，保证它的有序,尽管有change buffer

使用二级索引，需要回表到聚簇索引中查找数据，但回表也是有代价的：
1. 二级索引的叶子节点存放的是主键值，这些主键值是散列存放的，访问聚簇索引是随机IO

因此如果回表的数据量很大，二级索引的效率就越低，甚至宁愿使用全表扫描。

##### 2. 如何建立索引
总结如下：
1. 最好为那些列基数(重复值越少，基数越大)大的列建立索引，为基数太小的列建立索引效果可能不好。
2. 建立索引的列，在允许的情况下，数据类型的范围越小越好。
3. 鼓励只对字符串的前几个字符进行索引，即二级索引中索引记录只保留字符串的前几位
4. 最好让主键值AUTO_INCREMENT，或者让Innodb自动创建，因为主键值如果是随机插入的，影响插入性能。

##### 3. 如何使用索引
总结如下：
1. 由于联合索引按照从最左边的列开始排序，因此搜索条件中的各个列必须是联合索引中从最左边连续的列。
2. 匹配前缀词，如like '%.com' 这种语法会导致全表搜索，在插入相关列的时候，我们可以逆序插入。
3. 在查询列表中尽量不要全部查询，而只包含索引的列，这样能避免回表。
4. 如果索引列在比较表达式中不是以单独列的形式出现，而是以某个表达式或者函数调用形式出现的话，是用不到索引的。

### 参考资料
书籍：
《MySQL是怎样运行的：从根儿上理解MySQL》
《Mysql技术内幕 InnoDB存储引擎》（第二版）
《高性能MySql》（第三版）
官方资料：
https://dev.mysql.com/doc/refman/8.0/en/innodb-storage-engine.html